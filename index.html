<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Gastos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white flex items-center justify-center min-h-screen p-4">

  <div class="w-full max-w-3xl bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg text-center">
    <h1 class="text-3xl font-bold mb-6">Controle de Gastos</h1>

    <!-- Formul√°rio de Gastos -->
    <form id="gastoForm" class="grid grid-cols-1 sm:grid-cols-5 gap-4 mb-6 justify-center">
      <select id="quem" class="p-3 rounded-xl border dark:bg-gray-800 dark:border-gray-700" required>
        <option value="Leonardo">Leonardo</option>
        <option value="Camila">Camila</option>
      </select>
      <input type="number" step="0.01" id="valor" placeholder="Valor (R$)" class="p-3 rounded-xl border dark:bg-gray-800 dark:border-gray-700" required />
      <input type="text" id="categoria" placeholder="Categoria" class="p-3 rounded-xl border dark:bg-gray-800 dark:border-gray-700" required />
      <select id="tipo" class="p-3 rounded-xl border dark:bg-gray-800 dark:border-gray-700" required>
        <option value="pix">Pix</option>
        <option value="debito">D√©bito</option>
        <option value="credito">Cr√©dito</option>
      </select>
      <button type="submit" class="bg-green-600 text-white px-4 py-3 rounded-xl hover:bg-green-700 transition">
        Adicionar Gasto
      </button>
    </form>

    <!-- Formul√°rio de Saldo -->
    <form id="saldoForm" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 justify-center">
      <input type="number" step="0.01" id="valorSaldo" placeholder="Valor a adicionar (R$)" class="p-3 rounded-xl border dark:bg-gray-800 dark:border-gray-700" required />
      <input type="text" id="descricaoSaldo" placeholder="Descri√ß√£o (ex: Sal√°rio)" class="p-3 rounded-xl border dark:bg-gray-800 dark:border-gray-700" required />
      <button type="submit" class="bg-blue-600 text-white px-4 py-3 rounded-xl hover:bg-blue-700 transition">
        Adicionar Saldo
      </button>
    </form>

    <!-- Resumo -->
    <div class="mb-6 text-left">
      <h2 class="font-semibold text-xl mb-3">Resumo</h2>
      <p><strong>Saldo no banco:</strong> <span id="saldoBanco">R$ 0,00</span></p>
      <p><strong>Total gasto:</strong> <span id="totalGasto">R$ 0,00</span></p>
    </div>

    <!-- Gr√°fico -->
    <div class="mb-6">
      <canvas id="graficoGastos" width="400" height="200"></canvas>
    </div>

    <!-- Hist√≥rico -->
    <section class="mb-6 text-left max-h-64 overflow-y-auto">
      <h2 class="font-semibold text-xl mb-3">üìú Hist√≥rico de Movimenta√ß√µes</h2>
      <div id="historico" class="text-sm space-y-3"></div>
    </section>

    <!-- Bot√£o Reset -->
    <button id="btnReset" class="bg-red-600 text-white px-6 py-3 rounded-xl hover:bg-red-700 transition">
      Resetar Saldo, Gastos e Hist√≥rico
    </button>
  </div>

  <script>
    // Inicializa arrays
    let gastos = JSON.parse(localStorage.getItem("gastos")) || [];
    let entradas = JSON.parse(localStorage.getItem("entradas")) || [];

    // Elementos
    const gastoForm = document.getElementById("gastoForm");
    const saldoForm = document.getElementById("saldoForm");
    const saldoBancoEl = document.getElementById("saldoBanco");
    const totalGastoEl = document.getElementById("totalGasto");
    const historicoEl = document.getElementById("historico");
    const btnReset = document.getElementById("btnReset");
    const ctx = document.getElementById("graficoGastos").getContext("2d");

    // Formata valor para moeda brasileira
    function formatarMoeda(valor) {
      return valor.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    // Calcula totais de entradas, gastos e saldo atual
    function calcularTotais() {
      const totalEntradas = entradas.reduce((acc, e) => acc + e.valor, 0);
      const totalGastos = gastos.reduce((acc, g) => acc + g.valor, 0);
      const saldoAtual = totalEntradas - totalGastos;
      return { totalEntradas, totalGastos, saldoAtual };
    }

    // Atualiza os dados na tela e no localStorage
    function atualizarPainel() {
      const { totalEntradas, totalGastos, saldoAtual } = calcularTotais();

      saldoBancoEl.textContent = formatarMoeda(saldoAtual);
      totalGastoEl.textContent = formatarMoeda(totalGastos);

      localStorage.setItem("gastos", JSON.stringify(gastos));
      localStorage.setItem("entradas", JSON.stringify(entradas));

      atualizarGrafico();
      renderizarHistorico();
    }

    // Configura√ß√£o do gr√°fico (Chart.js)
    const grafico = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: [],
        datasets: [{
          label: "Gastos por Categoria",
          data: [],
          backgroundColor: [
            "#f87171", "#60a5fa", "#34d399", "#fbbf24", "#a78bfa", "#fb7185",
            "#22d3ee", "#f43f5e", "#8b5cf6"
          ],
          borderWidth: 1,
        }],
      },
      options: {
        plugins: {
          legend: {
            labels: { color: "#6b7280" } // cor cinza para legenda
          },
        },
        responsive: true,
        maintainAspectRatio: false,
      },
    });

    // Atualiza dados do gr√°fico
    function atualizarGrafico() {
      const categorias = {};
      gastos.forEach((g) => {
        categorias[g.categoria] = (categorias[g.categoria] || 0) + g.valor;
      });

      grafico.data.labels = Object.keys(categorias);
      grafico.data.datasets[0].data = Object.values(categorias);
      grafico.update();
    }

    // Renderiza hist√≥rico agrupado por m√™s e com detalhes
    function renderizarHistorico() {
      historicoEl.innerHTML = "";

      // Junta entradas e gastos em um s√≥ array
      const todosMovimentos = [
        ...entradas.map(e => ({
          tipo: "entrada",
          valor: e.valor,
          descricao: e.descricao,
          data: new Date(e.data)
        })),
        ...gastos.map(g => ({
          tipo: "gasto",
          quem: g.quem,
          valor: g.valor,
          categoria: g.categoria,
          pagamento: g.tipo,
          data: new Date(g.data)
        }))
      ];

      // Ordena do mais recente para o mais antigo
      todosMovimentos.sort((a,b) => b.data - a.data);

      // Agrupa por m√™s e ano
      const porMes = {};
      todosMovimentos.forEach(mov => {
        const mes = mov.data.toLocaleDateString("pt-BR", { month: "long", year: "numeric" });
        if (!porMes[mes]) porMes[mes] = [];
        porMes[mes].push(mov);
      });

      // Para cada m√™s cria bloco e lista as movimenta√ß√µes
      for(const mes in porMes) {
        const bloco = document.createElement("div");
        bloco.classList.add("mb-4");
        bloco.innerHTML = `<h3 class="font-bold mb-2 capitalize">${mes}</h3>`;

        porMes[mes].forEach(mov => {
          let texto = "";
          if (mov.tipo === "entrada") {
            texto = `<span class="text-green-600 font-semibold">+ ${formatarMoeda(mov.valor)}</span> ‚Äì ${mov.descricao}`;
          } else {
            texto = `<span class="text-red-600 font-semibold">- ${formatarMoeda(mov.valor)}</span> ‚Äì ${mov.quem} | ${mov.categoria} (${mov.pagamento})`;
          }

          const linha = document.createElement("p");
          linha.className = "text-gray-700 dark:text-gray-300";
          linha.innerHTML = `${mov.data.toLocaleDateString("pt-BR")} - ${texto}`;
          bloco.appendChild(linha);
        });

        historicoEl.appendChild(bloco);
      }
    }

    // Eventos para enviar formul√°rios

    gastoForm.addEventListener("submit", e => {
      e.preventDefault();

      const quem = document.getElementById("quem").value;
      const valor = parseFloat(document.getElementById("valor").value);
      const categoria = document.getElementById("categoria").value.trim();
      const tipo = document.getElementById("tipo").value;

      if (!valor || valor <= 0 || categoria === "") {
        alert("Preencha os campos corretamente.");
        return;
      }

      gastos.push({ quem, valor, categoria, tipo, data: new Date().toISOString() });
      gastoForm.reset();
      atualizarPainel();
    });

    saldoForm.addEventListener("submit", e => {
      e.preventDefault();

      const valor = parseFloat(document.getElementById("valorSaldo").value);
      const descricao = document.getElementById("descricaoSaldo").value.trim();

      if (!valor || valor <= 0 || descricao === "") {
        alert("Preencha os campos corretamente.");
        return;
      }

      entradas.push({ valor, descricao, data: new Date().toISOString() });
      saldoForm.reset();
      atualizarPainel();
    });

    // Bot√£o para resetar tudo
    btnReset.addEventListener("click", () => {
      if (confirm("Tem certeza que deseja resetar saldo, gastos e hist√≥rico?")) {
        gastos = [];
        entradas = [];
        localStorage.removeItem("gastos");
        localStorage.removeItem("entradas");
        atualizarPainel();
      }
    });

    // Inicializa a p√°gina
    atualizarPainel();
  </script>
</body>
</html>
