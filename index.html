<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Controle de Gastos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  </head>
  <body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white">
    <div class="min-h-screen flex flex-col items-center p-4">
      <h1 class="text-3xl font-bold mb-4">Controle de Gastos</h1>

      <form id="gastoForm" class="w-full max-w-3xl grid grid-cols-1 sm:grid-cols-4 gap-4 mb-6">
        <select id="quem" class="p-3 rounded-xl border dark:bg-gray-800 dark:border-gray-700">
          <option value="Leonardo">Leonardo</option>
          <option value="Camila">Camila</option>
        </select>
        <input type="number" step="0.01" id="valor" placeholder="Valor (R$)" class="p-3 rounded-xl border dark:bg-gray-800 dark:border-gray-700" required />
        <input type="text" id="categoria" placeholder="Categoria" class="p-3 rounded-xl border dark:bg-gray-800 dark:border-gray-700" required />
        <select id="tipo" class="p-3 rounded-xl border dark:bg-gray-800 dark:border-gray-700">
          <option value="pix">Pix</option>
          <option value="debito">DÃ©bito</option>
          <option value="credito">CrÃ©dito</option>
        </select>
        <button type="submit" class="bg-green-600 text-white px-4 py-3 rounded-xl hover:bg-green-700 transition col-span-1 sm:col-span-1">
          Adicionar Gasto
        </button>
      </form>

      <form id="saldoForm" class="w-full max-w-3xl grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
        <input type="number" step="0.01" id="valorSaldo" placeholder="Valor a adicionar (R$)" class="p-3 rounded-xl border dark:bg-gray-800 dark:border-gray-700" required />
        <input type="text" id="descricaoSaldo" placeholder="DescriÃ§Ã£o (ex: SalÃ¡rio)" class="p-3 rounded-xl border dark:bg-gray-800 dark:border-gray-700" required />
        <button type="submit" class="bg-blue-600 text-white px-4 py-3 rounded-xl hover:bg-blue-700 transition col-span-1 sm:col-span-1">
          Adicionar Saldo
        </button>
      </form>

      <div class="w-full max-w-3xl bg-white dark:bg-gray-800 p-4 rounded-xl shadow mb-6">
        <h2 class="font-semibold mb-2">Resumo</h2>
        <p>Saldo no banco: <span id="saldoBanco">R$ 0,00</span></p>
        <p>Total gasto: <span id="totalGasto">R$ 0,00</span></p>
      </div>

      <div class="w-full max-w-3xl bg-white dark:bg-gray-800 p-4 rounded-xl shadow mb-6">
        <canvas id="graficoGastos" width="400" height="200"></canvas>
      </div>

      <section class="w-full max-w-3xl bg-white dark:bg-gray-800 p-4 rounded-xl shadow mb-6">
        <h2 class="font-semibold mb-4">ðŸ“œ HistÃ³rico de MovimentaÃ§Ãµes</h2>
        <div id="historico" class="space-y-4 max-h-[300px] overflow-y-auto text-sm"></div>
      </section>
    </div>

    <script>
      let gastos = [];
      let entradas = [];

      if (localStorage.getItem("gastos")) gastos = JSON.parse(localStorage.getItem("gastos"));
      if (localStorage.getItem("entradas")) entradas = JSON.parse(localStorage.getItem("entradas"));

      const form = document.getElementById("gastoForm");
      const saldoForm = document.getElementById("saldoForm");
      const saldoBancoEl = document.getElementById("saldoBanco");
      const totalGastoEl = document.getElementById("totalGasto");
      const historicoEl = document.getElementById("historico");
      const ctx = document.getElementById("graficoGastos").getContext("2d");

      function formatarMoeda(valor) {
        return valor.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
      }

      function calcularTotais() {
        const totalEntradas = entradas.reduce((acc, e) => acc + e.valor, 0);
        const totalGastos = gastos.reduce((acc, g) => acc + g.valor, 0);
        const saldoAtual = totalEntradas - totalGastos;
        return { totalEntradas, totalGastos, saldoAtual };
      }

      function atualizarPainel() {
        const { totalEntradas, totalGastos, saldoAtual } = calcularTotais();

        saldoBancoEl.textContent = formatarMoeda(saldoAtual);
        totalGastoEl.textContent = formatarMoeda(totalGastos);

        localStorage.setItem("gastos", JSON.stringify(gastos));
        localStorage.setItem("entradas", JSON.stringify(entradas));

        atualizarGrafico();
        renderizarHistorico();
      }

      let grafico = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: [],
          datasets: [
            {
              label: "Gastos por Categoria",
              data: [],
              backgroundColor: ["#f87171", "#60a5fa", "#34d399", "#fbbf24", "#a78bfa", "#fb7185"],
              borderWidth: 1,
            },
          ],
        },
        options: {
          plugins: {
            legend: {
              labels: { color: "#ccc" },
            },
          },
        },
      });

      function atualizarGrafico() {
        const categorias = {};
        gastos.forEach((g) => {
          categorias[g.categoria] = (categorias[g.categoria] || 0) + g.valor;
        });

        grafico.data.labels = Object.keys(categorias);
        grafico.data.datasets[0].data = Object.values(categorias);
        grafico.update();
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();

        const quem = document.getElementById("quem").value;
        const valor = parseFloat(document.getElementById("valor").value);
        const categoria = document.getElementById("categoria").value.trim();
        const tipo = document.getElementById("tipo").value;

        if (!valor || valor <= 0 || categoria === "") {
          alert("Preencha os campos corretamente.");
          return;
        }

        gastos.push({ quem, valor, categoria, tipo, data: new Date().toISOString() });
        form.reset();
        atualizarPainel();
      });

      saldoForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const valor = parseFloat(document.getElementById("valorSaldo").value);
        const descricao = document.getElementById("descricaoSaldo").value.trim();

        if (!valor || valor <= 0 || descricao === "") {
          alert("Preencha os campos corretamente.");
          return;
        }

        entradas.push({ valor, descricao, data: new Date().toISOString() });
        saldoForm.reset();
        atualizarPainel();
      });

      function renderizarHistorico() {
        historicoEl.innerHTML = "";

        const todosMovimentos = [
          ...entradas.map((e) => ({
            tipo: "entrada",
            valor: e.valor,
            descricao: e.descricao,
            data: new Date(e.data),
          })),
          ...gastos.map((g) => ({
            tipo: "gasto",
            quem: g.quem,
            valor: g.valor,
            categoria: g.categoria,
            pagamento: g.tipo,
            data: new Date(g.data),
          })),
        ];

        todosMovimentos.sort((a, b) => b.data - a.data);

        const porMes = {};

        todosMovimentos.forEach((mov) => {
          const mes = mov.data.toLocaleDateString("pt-BR", { month: "long", year: "numeric" });
          if (!porMes[mes]) porMes[mes] = [];
          porMes[mes].push(mov);
        });

        for (const mes in porMes) {
          const bloco = document.createElement("div");
          bloco.innerHTML = `<h3 class="font-bold mb-2">${mes}</h3>`;

          porMes[mes].forEach((mov) => {
            let texto = "";

            if (mov.tipo === "entrada") {
              texto = `<span class="text-green-500">+ ${formatarMoeda(mov.valor)}</span> â€“ ${mov.descricao}`;
            } else {
              texto = `<span class="text-red-500">- ${formatarMoeda(mov.valor)}</span> â€“ ${mov.quem} | ${mov.categoria} (${mov.pagamento})`;
            }

            const linha = document.createElement("p");
            linha.className = "text-gray-700 dark:text-gray-300";
            linha.innerHTML = `${mov.data.toLocaleDateString("pt-BR")} - ${texto}`;
            bloco.appendChild(linha);
          });

          historicoEl.appendChild(bloco);
        }
      }

      atualizarPainel();
    </script>
  </body>
</html>
